// æ–‡ä»¶è·¯å¾„: DaChuang-backend/server.js (å¸¦é¢˜åº“å¡«å……åŠŸèƒ½)

require('dotenv').config({ path: '.env' });
const express = require('express');
const cors = require('cors');
const sequelize = require('./config/database');

// --- 1. å¼•å…¥æ‰€æœ‰æ¨¡å‹ ---
const User = require('./models/User');
const Question = require('./models/Question');
const DailyQuizLog = require('./models/DailyQuizLog');
const CheckInLog = require('./models/CheckInLog');

// --- 2. é¢˜åº“æ•°æ® (æˆ‘ä»¬è®¾è®¡å¥½çš„10é“é¢˜) ---
const quizBank = [
  {
    question_text: "å­”å­åœ¨ã€Šè®ºè¯­ã€‹ä¸­å¼ºè°ƒçš„æ ¸å¿ƒé“å¾·æ¦‚å¿µâ€œä»â€ (rÃ©n)ï¼Œå…¶å†…æ¶µï¼ˆå¦‚â€œå…‹å·±å¤ç¤¼â€ã€â€œçˆ±äººâ€ï¼‰ä¸å¤å¸Œè…Šå“²å­¦ä¸­å“ªä¸ªæ¦‚å¿µæœ€èƒ½è¿›è¡Œå¯¹æ¯”ï¼Œä¸¤è€…éƒ½æ¢è®¨â€œäººçš„å“è¶Šä¸ç¾å¾·â€ï¼Ÿ",
    options: ["Logos (é€»å„æ–¯ - é€»è¾‘/é“)", "Arete (é˜¿ç‘å¿’ - å“è¶Š/ç¾å¾·)", "Eros (çˆ±è‹¥æ–¯ - çˆ±æ¬²)", "Atom (åŸå­)"],
    correct_answer: 1, // B æ˜¯ç´¢å¼• 1
    analysis: "â€œä»â€æ˜¯å„’å®¶ä¼¦ç†çš„æœ€é«˜å¢ƒç•Œï¼ŒæŒ‡ä¸ªä½“é“å¾·çš„å®Œå–„ã€‚å¤å¸Œè…Šçš„ â€œAreteâ€ (é˜¿ç‘å¿’) ä¹ŸæŒ‡ä¸€ç§â€œå“è¶Šâ€ï¼Œå³äººï¼ˆæˆ–ç‰©ï¼‰èƒ½è¾¾åˆ°çš„æœ€ä½³çŠ¶æ€æˆ–åŠŸèƒ½ï¼Œè‹æ ¼æ‹‰åº•å’ŒæŸæ‹‰å›¾éƒ½å°†å…¶å¼•ç”³ä¸ºçµé­‚çš„ç¾å¾·ã€‚"
  },
  {
    question_text: "è€å­åœ¨ã€Šé“å¾·ç»ã€‹ä¸­æè¿°çš„â€œé“â€ (Dao) æ˜¯ä¸‡ç‰©çš„æœ¬æºå’Œæ³•åˆ™ï¼Œå¤å¸Œè…Šå“²å­¦å®¶èµ«æ‹‰å…‹åˆ©ç‰¹ (Heraclitus) ä¹Ÿæå‡ºäº†ä¸€ä¸ªç›¸ä¼¼çš„æ¦‚å¿µï¼ŒæŒ‡ä»£å®‡å®™ä¸­æ°¸æ’çš„ç§©åºå’Œæ³•åˆ™ï¼Œè¿™ä¸ªæ¦‚å¿µæ˜¯ï¼Ÿ",
    options: ["Eudaimonia (å¹¸ç¦)", "Logos (é€»å„æ–¯)", "Chaos (æ··æ²Œ)", "Techne (æŠ€è‰º)"],
    correct_answer: 1, // B æ˜¯ç´¢å¼• 1
    analysis: "èµ«æ‹‰å…‹åˆ©ç‰¹æå‡ºçš„ â€œLogosâ€ (é€»å„æ–¯) æ˜¯ä¸€ç§ç†æ€§çš„ã€ç»Ÿä¸€çš„å®‡å®™æ³•åˆ™ï¼Œå®ƒæ”¯é…ç€ä¸‡ç‰©çš„å˜åŒ–ï¼ˆå¦‚â€œäººä¸èƒ½ä¸¤æ¬¡è¸å…¥åŒä¸€æ¡æ²³æµâ€ï¼‰ï¼Œè¿™ä¸â€œé“â€ä½œä¸ºå®‡å®™ç»ˆæè§„å¾‹çš„æ€æƒ³æœ‰å¾ˆå¼ºçš„å¯æ¯”æ€§ã€‚"
  },
  {
    question_text: "æŸæ‹‰å›¾åœ¨ã€Šç†æƒ³å›½ã€‹(Republic) ä¸­æå‡ºçš„â€œå“²å­¦ç‹â€ (Philosopher King) ç»Ÿæ²»ç†å¿µï¼Œä¸ä¸­å›½å…ˆç§¦å“ªä½æ€æƒ³å®¶çš„â€œåœ£äººâ€æˆ–â€œå›å­â€æ²»å›½ç†å¿µæœ€ä¸ºç›¸ä¼¼ï¼Ÿ",
    options: ["éŸ©éå­ (æ³•å®¶)", "å¢¨å­ (å¢¨å®¶)", "å­”å­ (å„’å®¶)", "å­™å­ (å…µå®¶)"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "æŸæ‹‰å›¾çš„â€œå“²å­¦ç‹â€æ˜¯æŒ‡æœ€æœ‰æ™ºæ…§ã€æœ€å¯Œå¾·æ€§çš„å“²å­¦å®¶æ¥ç»Ÿæ²»åŸé‚¦ã€‚è¿™ä¸å„’å®¶ï¼ˆå­”å­ã€å­Ÿå­ï¼‰ä¸»å¼ åº”ç”±å…·å¤‡é«˜åº¦é“å¾·ä¿®å…»çš„â€œåœ£äººâ€æˆ–â€œå›å­â€æ¥æ²»ç†å›½å®¶çš„æ€æƒ³ï¼ˆå¾·æ²»ï¼‰é«˜åº¦ä¸€è‡´ã€‚"
  },
  {
    question_text: "è·é©¬å²è¯—ï¼ˆå¦‚ã€Šä¼Šåˆ©äºšç‰¹ã€‹ï¼‰ä¸»è¦æç»˜äº†è‹±é›„çš„æ„¤æ€’ã€æˆ˜äº‰ä¸è£èª‰ï¼Œè€Œä¸­å›½æœ€æ—©çš„è¯—æ­Œæ€»é›†ã€Šè¯—ç»ã€‹åˆ™æ›´å¤šå…³æ³¨ï¼Ÿ",
    options: ["ä¼—ç¥çš„è°±ç³»ä¸æˆ˜äº‰", "åˆ›ä¸–ç¥è¯ä¸æ´ªæ°´", "æ°‘é—´ç”Ÿæ´»ã€åŠ³åŠ¨ã€å©šä¸§ä¸æƒ…æ„Ÿ", "æŠ½è±¡çš„å“²å­¦è¾©è®º"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "ã€Šè¯—ç»ã€‹ä¸­çš„â€œé£â€éƒ¨åˆ†åŒ…å«äº†å¤§é‡æºäºæ°‘é—´çš„ç°å®ä¸»ä¹‰è¯—æ­Œï¼Œåæ˜ äº†å‘¨æœçš„ç¤¾ä¼šç”Ÿæ´»å’Œæ™®é€šäººçš„æƒ…æ„Ÿï¼Œè€Œè·é©¬å²è¯—åˆ™èšç„¦äºè¶…å‡¡çš„è‹±é›„åŠå…¶æ‚²å‰§å‘½è¿ã€‚"
  },
  {
    question_text: "ï¼ˆçµæ„Ÿæºäºã€Šä¼šé¥®ç¯‡ã€‹ï¼‰æŸæ‹‰å›¾åœ¨ã€Šä¼šé¥®ç¯‡ã€‹(Symposium) ä¸­ï¼Œé€šè¿‡è‹æ ¼æ‹‰åº•ä¹‹å£é˜è¿°çš„â€œçˆ±â€ (Eros) æ˜¯ä¸€ç§ç²¾ç¥çš„é˜¶æ¢¯ï¼Œå…¶æœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†å¯¼å‘ä»€ä¹ˆï¼Ÿ",
    options: ["æ”¿æ²»æƒåŠ›çš„è·å–", "è´¢å¯Œä¸åèª‰", "å¯¹â€œç¾æœ¬èº«â€ (ç†å¿µ) çš„æ²‰æ€", "èº«ä½“çš„æ¬¢æ„‰ä¸ç¹è¡"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "åœ¨ã€Šä¼šé¥®ç¯‡ã€‹ä¸­ï¼Œçˆ±ï¼ˆErosï¼‰è¢«æè¿°ä¸ºä¸€ä¸ªæ¢¯å­ï¼šä»çˆ±ä¸€ä¸ªç¾çš„èº«ä½“ï¼Œåˆ°çˆ±æ‰€æœ‰ç¾çš„èº«ä½“ï¼Œå†åˆ°çˆ±ç¾çš„å¿ƒçµã€ç¾çš„åˆ¶åº¦ï¼Œæœ€ç»ˆè¾¾åˆ°å¯¹â€œç¾æœ¬èº«â€ï¼ˆå³ç¾çš„ç†å¿µ/The Form of Beautyï¼‰çš„å“²å­¦æ²‰æ€ã€‚"
  },
  {
    question_text: "å­Ÿå­ (Mencius) æå‡ºäº†â€œæ€§å–„è®ºâ€ï¼Œè®¤ä¸ºäººç”Ÿæ¥å°±æœ‰â€œå››ç«¯â€ã€‚ä¸ä»–ç›¸åï¼Œå“ªä½å„’å®¶æ€æƒ³å®¶æå‡ºäº†â€œæ€§æ¶è®ºâ€ï¼Œä¸»å¼ â€œåŒ–æ€§èµ·ä¼ªâ€ï¼ˆé€šè¿‡åå¤©æ•™åŒ–æ”¹å˜æœ¬æ€§ï¼‰ï¼Ÿ",
    options: ["è€å­ (Xunzi)", "è‘£ä»²èˆ’ (Dong Zhongshu)", "æœ±ç†¹ (Zhu Xi)", "ç‹é˜³æ˜ (Wang Yangming)"],
    correct_answer: 0, // A æ˜¯ç´¢å¼• 0
    analysis: "è€å­æ˜¯å…ˆç§¦å„’å®¶å¦ä¸€ä½å¤§å¸ˆï¼Œä»–è®¤ä¸ºäººæ€§æœ¬â€œæ¶â€ï¼ˆå³å¸¦æœ‰åŸå§‹æ¬²æœ›ï¼‰ï¼Œå¿…é¡»é€šè¿‡åå¤©çš„ç¤¼ä¹‰å’Œæ•™è‚²ï¼ˆâ€œä¼ªâ€ï¼‰æ¥åŠ ä»¥æ”¹é€ å’Œçº¦æŸï¼Œè¿™ä¸å­Ÿå­çš„è§‚ç‚¹å½¢æˆäº†å„’å®¶å†…éƒ¨çš„ç»å…¸å¯¹æ¯”ã€‚"
  },
  {
    question_text: "è¢«ç§°ä¸ºâ€œè¥¿æ–¹é€»è¾‘å­¦ä¹‹çˆ¶â€çš„äºšé‡Œå£«å¤šå¾· (Aristotle) ä»¥å…¶ä¸‰æ®µè®º (Syllogism) è‘—ç§°ã€‚åœ¨ä¸­å›½å…ˆç§¦æ—¶æœŸï¼Œå“ªä¸ªå­¦æ´¾ä¹Ÿå‘å±•äº†å¤æ‚çš„é€»è¾‘å­¦ã€è®¤è¯†è®ºå’Œè®ºè¾©æœ¯ï¼ˆå¦‚â€œè¾©â€ä¸â€œæ•…â€ï¼‰ï¼Ÿ",
    options: ["å„’å®¶ (Confucianism)", "æ³•å®¶ (Legalism)", "å¢¨å®¶ (Mohism)", "é˜´é˜³å®¶ (Yin-Yang School)"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "å¢¨å®¶åæœŸçš„ã€Šå¢¨ç»ã€‹ä¸­åŒ…å«äº†å¤§é‡å…³äºé€»è¾‘å­¦ã€å‡ ä½•å­¦å’Œç‰©ç†å­¦çš„è®ºè¿°ï¼Œå…¶å¯¹â€œæ•…â€ï¼ˆåŸå› ï¼‰ã€â€œç±»â€ï¼ˆå½’çº³/ç±»æ¯”ï¼‰çš„æ¢è®¨ï¼Œè¢«è®¤ä¸ºæ˜¯å¯ä¸äºšé‡Œå£«å¤šå¾·é€»è¾‘å­¦ç›¸åª²ç¾çš„å¤ä»£é€»è¾‘ä½“ç³»ã€‚"
  },
  {
    question_text: "å¤å¸Œè…Šæ‚²å‰§ï¼ˆå¦‚ç´¢ç¦å…‹å‹’æ–¯çš„ã€Šä¿„ç‹„æµ¦æ–¯ç‹ã€‹ï¼‰çš„æ ¸å¿ƒåœ¨äºæ¢è®¨äººä¸â€œå‘½è¿â€(Fate) çš„æŠ—äº‰ä¸å¿…ç„¶çš„æ¯ç­ã€‚è€Œä¸­å›½å¤å…¸æˆæ›²ï¼ˆå¦‚å…ƒæ‚å‰§ã€Šçª¦å¨¥å†¤ã€‹ï¼‰åœ¨ç»“å±€ä¸Šæ›´å€¾å‘äºï¼Ÿ",
    options: ["è‹±é›„åœ¨æŠ—äº‰ä¸­å…‰è£æ¯ç­", "ä¼—ç¥é™ä¸´è§£å†³ä¸€åˆ‡å†²çª", "å–„æ¶æœ‰æŠ¥ä¸å¤§å›¢åœ†", "å¼€æ”¾å¼ç»“å±€ï¼Œå¼•äººæ·±æ€"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "è¥¿æ–¹å¤å…¸æ‚²å‰§å¼ºè°ƒå‘½è¿çš„ä¸å¯è¿æŠ—æ€§ã€‚è€Œä¸­å›½å¤å…¸æˆæ›²æ·±å—å„’å®¶å’Œæ°‘é—´ä¼¦ç†å½±å“ï¼Œå¼ºè°ƒâ€œå–„æœ‰å–„æŠ¥ï¼Œæ¶æœ‰æ¶æŠ¥â€ï¼Œå³ä½¿ä¸»è§’åœ¨ç”Ÿå‰è’™å†¤ï¼ˆå¦‚çª¦å¨¥ï¼‰ï¼Œæœ€ç»ˆä¹Ÿå¿…é¡»é€šè¿‡è¶…è‡ªç„¶åŠ›é‡ï¼ˆå¦‚æ¸…å®˜ã€ç¥ä»™ï¼‰å®ç°æ­£ä¹‰ï¼Œè¾¾æˆä¸€ä¸ªé“å¾·ä¸Šçš„å¤§å›¢åœ†ã€‚"
  },
  {
    question_text: "ä¸­å›½å…ˆç§¦çš„â€œæ³•å®¶â€ï¼ˆLegalismï¼‰æ€æƒ³å¼ºè°ƒæ³•å¾‹æ˜¯å›ä¸»åŠ å¼ºç»Ÿæ²»ã€å¯Œå›½å¼ºå…µçš„å·¥å…·ã€‚è€Œå¤ç½—é©¬æ³•ï¼ˆRoman Lawï¼‰å¯¹ä¸–ç•Œæœ€å¤§çš„è´¡çŒ®åœ¨äºå®ƒæœ€ç»ˆå‘å±•ä¸ºä¸€ç§ï¼Ÿ",
    options: ["ä»…é€‚ç”¨äºè´µæ—çš„æ³•å¾‹", "åŸºäºç¥å¯çš„å®—æ•™æ³•å¾‹", "å¼ºè°ƒç¨‹åºæ­£ä¹‰å’Œä¿æŠ¤ç§æœ‰è´¢äº§æƒçš„æ³•å¾‹ä½“ç³»", "ä»…ç”¨äºå†›äº‹ç®¡ç†çš„æ³•å¾‹"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "æ³•å®¶æ˜¯â€œRule *by* Lawâ€ï¼ˆå›ä¸»åˆ©ç”¨æ³•å¾‹ï¼‰ï¼Œè€Œç½—é©¬æ³•æ˜¯â€œRule *of* Lawâ€ï¼ˆæ³•å¾‹è‡³ä¸Šï¼‰çš„é›å½¢ã€‚ç½—é©¬æ³•ï¼ˆå°¤å…¶æ˜¯ã€ŠæŸ¥å£«ä¸å°¼æ³•å…¸ã€‹ï¼‰ç³»ç»Ÿåœ°ç¡®ç«‹äº†ç§æœ‰è´¢äº§æƒã€å¥‘çº¦ç²¾ç¥å’Œæ³•å¾‹ç¨‹åºï¼Œæˆä¸ºåä¸–å¤§é™†æ³•ç³»çš„åŸºçŸ³ã€‚"
  },
  {
    question_text: "â€œè®¤è¯†ä½ è‡ªå·±â€ (Know thyself) æ˜¯é•Œåˆ»åœ¨å¤å¸Œè…Šå¾·å°”è²ç¥åº™ä¸Šçš„ç®´è¨€ï¼Œä¹Ÿæ˜¯å“ªä½å“²å­¦å®¶æ€æƒ³çš„æ ¸å¿ƒå‡ºå‘ç‚¹ï¼Ÿ",
    options: ["èµ«æ‹‰å…‹åˆ©ç‰¹ (Heraclitus)", "å¾·è°Ÿå…‹åˆ©ç‰¹ (Democritus)", "è‹æ ¼æ‹‰åº• (Socrates)", "åº„å­ (Zhuangzi)"],
    correct_answer: 2, // C æ˜¯ç´¢å¼• 2
    analysis: "è‹æ ¼æ‹‰åº•å¸¸å¼•ç”¨è¿™å¥ç®´è¨€ï¼Œä»–è®¤ä¸ºå“²å­¦çš„é¦–è¦ä»»åŠ¡ä¸æ˜¯ç ”ç©¶è‡ªç„¶ï¼Œè€Œæ˜¯é€šè¿‡åæ€æ¥å®¡è§†è‡ªå·±çš„çµé­‚å’ŒçŸ¥è¯†ï¼Œå³â€œæœªç»å®¡è§†çš„äººç”Ÿæ˜¯ä¸å€¼å¾—è¿‡çš„â€ã€‚"
  }
];

// --- 3. æ£€æŸ¥å¹¶å¡«å……é¢˜åº“çš„å‡½æ•° ---
async function populateDatabase() {
  try {
    // æ£€æŸ¥ Question è¡¨ä¸­æ˜¯å¦å·²æœ‰æ•°æ®
    const count = await Question.count();
    
    if (count === 0) {
      // å¦‚æœè¡¨æ˜¯ç©ºçš„, æ‰¹é‡æ’å…¥é¢˜åº“
      await Question.bulkCreate(quizBank);
      console.log('âœ… é¢˜åº“å·²æˆåŠŸå¡«å…… (10 é“é¢˜ç›®).');
    } else {
      console.log('â„¹ï¸ é¢˜åº“å·²æœ‰æ•°æ®, æ— éœ€å¡«å…….');
    }
  } catch (error) {
    console.error('âŒ å¡«å……é¢˜åº“æ—¶å‡ºé”™:', error);
  }
}

// --- 4. å¯åŠ¨æœåŠ¡å™¨çš„ä¸»å‡½æ•° ---
const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

// --- API è·¯ç”± ---
app.use('/api/auth', require('./routes/auth'));
app.use('/api/user', require('./routes/user'));
app.use('/api/quiz', require('./routes/quiz'));
app.use('/api/test', require('./routes/test'));

app.get('/', (req, res) => {
  res.send('æ¬¢è¿æ¥åˆ° DaChuang åç«¯æœåŠ¡å™¨! (ä½¿ç”¨ MySQL)');
});

async function startServer() {
  try {
    // 1. è¿æ¥æ•°æ®åº“
    await sequelize.authenticate();
    console.log('âœ… MySQL æ•°æ®åº“è¿æ¥æˆåŠŸ.');
    
    // 2. åŒæ­¥æ‰€æœ‰æ¨¡å‹ (è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°è¡¨)
    //    force: false (é»˜è®¤) : å¦‚æœè¡¨å·²å­˜åœ¨, ä¸åˆ é™¤
    //    alter: true : æ£€æŸ¥å·®å¼‚å¹¶ä¿®æ”¹è¡¨ (æ›´å®‰å…¨, ä½†å¯èƒ½æ…¢)
    await sequelize.sync({ alter: true }); 
    console.log('ğŸ”„ æ‰€æœ‰æ¨¡å‹å·²æˆåŠŸåŒæ­¥.');

    // 3. å¡«å……é¢˜åº“ (!!! æ–°å¢æ­¥éª¤ !!!)
    await populateDatabase();
    
    // 4. å¯åŠ¨ Express æœåŠ¡å™¨
    app.listen(PORT, () => {
      console.log(`ğŸš€ åç«¯æœåŠ¡å™¨æ­£åœ¨ http://localhost:${PORT} ä¸Šè¿è¡Œ`);
    });
  } catch (error) {
    console.error('âŒ æ— æ³•å¯åŠ¨æœåŠ¡å™¨:', error);
  }
}

// è¿è¡Œå¯åŠ¨å‡½æ•°
startServer();